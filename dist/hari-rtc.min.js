!function(e){e.module("hariRtc.config",[]).value("hariRtc.config",{debug:!0}),e.module("hariRtc.directives",[]),e.module("hariRtc.services",[]),e.module("hariRtc",["btford.socket-io","ionic","config","hariRtc.config","hariRtc.directives","hariRtc.services"])}(angular),angular.module("hariRtc").run(function(e,t){t.on("messageReceived",function(e,t){switch(t.type){case"call":iRestModal.show("views/call.html","CallCtrl",{isCalling:!1,contactName:e})}})}),angular.module("hariRtc").controller("CallCtrl",function(e,t,n,o,i,a,c,s){function r(t,n){console.log((new Date).toString()+": calling to "+n+", isInitiator: "+t),clearInterval(window.ringingIntervalId);var o={isInitiator:t,turn:{host:"stun:stun.l.google.com:19302",username:"test",password:"test"},streams:{audio:!0,video:!0}},i=new cordova.plugins.phonertc.Session(o);i.on("sendMessage",function(e){a.emit("sendMessage",n,{type:"phonertc_handshake",data:JSON.stringify(e)})}),i.on("answer",function(){console.log("Answered!")}),i.on("disconnect",function(){e.contacts[n]&&delete e.contacts[n],0===Object.keys(e.contacts).length&&(a.emit("sendMessage",n,{type:"ignore"}),e.closeModal())}),i.call(),e.contacts[n]=i}function l(t,n){switch(n.type){case"answer":e.$apply(function(){e.callInProgress=!0,o(e.updateVideoPosition,1e3)});var i=Object.keys(e.contacts);0!==i.length&&a.emit("sendMessage",t,{type:"add_to_group",contacts:i,isInitiator:!1}),r(!0,t);break;case"ignore":var s=Object.keys(e.contacts).length;if(s>0){e.contacts[t]&&(e.contacts[t].close(),delete e.contacts[t]);var l=e.hideFromContactList.indexOf(t);l>-1&&e.hideFromContactList.splice(l,1),0===Object.keys(e.contacts).length&&e.closeModal()}else e.closeModal();break;case"phonertc_handshake":-1===d.indexOf(n.data)&&(e.contacts[t].receiveMessage(JSON.parse(n.data)),d.push(n.data));break;case"add_to_group":n.contacts.forEach(function(t){e.hideFromContactList.push(t),r(n.isInitiator,t),n.isInitiator||o(function(){a.emit("sendMessage",t,{type:"add_to_group",contacts:[c.currentName],isInitiator:!0})},1500)})}}console.log("parameter "+JSON.stringify(s));var d=[];e.callInProgress=!1,e.isCalling=s.isCalling,e.contactName=s.contactName,e.allContacts=c.onlineUsers,e.contacts={},e.hideFromContactList=[e.contactName],e.muted=!1,i.fromTemplateUrl("templates/select_contact.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.selectContactModal=t}),navigator.notification.beep(1),window.ringingIntervalId=setInterval(navigator.notification.beep,2500,1),e.isCalling&&a.emit("sendMessage",s.contactName,{type:"call"}),e.ignore=function(){clearInterval(window.ringingIntervalId);var t=Object.keys(e.contacts);t.length>0?e.contacts[t[0]].disconnect():(a.emit("sendMessage",s.contactName,{type:"ignore"}),e.closeModal())},e.end=function(){clearInterval(window.ringingIntervalId),Object.keys(e.contacts).forEach(function(t){e.contacts[t].close(),delete e.contacts[t]}),e.closeModal()},e.answer=function(){e.callInProgress||(e.callInProgress=!0,o(e.updateVideoPosition,1e3),r(!1,s.contactName),setTimeout(function(){console.log("sending answer"),a.emit("sendMessage",s.contactName,{type:"answer"})},1500))},e.updateVideoPosition=function(){n.$broadcast("videoView.updatePosition")},e.openSelectContactModal=function(){cordova.plugins.phonertc.hideVideoView(),e.selectContactModal.show()},e.closeSelectContactModal=function(){cordova.plugins.phonertc.showVideoView(),e.selectContactModal.hide()},e.addContact=function(t){e.hideFromContactList.push(t),a.emit("sendMessage",t,{type:"call"}),cordova.plugins.phonertc.showVideoView(),e.selectContactModal.hide()},e.hideCurrentUsers=function(){return function(t){return-1===e.hideFromContactList.indexOf(t)}},e.toggleMute=function(){e.muted=!e.muted,Object.keys(e.contacts).forEach(function(t){var n=e.contacts[t];n.streams.audio=!e.muted,n.renegotiate()})},a.on("messageReceived",l),e.$on("$destroy",function(){clearInterval(window.ringingIntervalId),a.removeListener("messageReceived",l)})}),angular.module("hariRtc.directives").directive("videoView",function(e,t){return{restrict:"E",template:'<div class="video-container"></div>',replace:!0,link:function(n,o){function i(){cordova.plugins.phonertc.setVideoView({container:o[0],local:{position:[240,240],size:[50,50]}})}t(i,500),e.$on("videoView.updatePosition",i)}}}),angular.module("hariRtc.services").factory("ContactsService",function(e){var t=[];return e.on("online",function(e){-1===t.indexOf(e)&&t.push(e)}),e.on("offline",function(e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}),{onlineUsers:t,setOnlineUsers:function(e,n){this.currentName=n,t.length=0,e.forEach(function(e){e!==n&&t.push(e)})}}}),angular.module("hariRtc.services").factory("hariModal",function(e,t,n,o,i){function a(o,a,r){var l,d=n.defer(),u=t.$new(),g=u.$id;return e.fromTemplateUrl(o,{scope:u,animation:"slide-in-up"}).then(function(e){u.modal=e,u.openModal=function(){u.modal.show()},u.closeModal=function(e){d.resolve(e),u.modal.hide()},u.$on("modal.hidden",function(e){if(e.currentScope){var t=e.currentScope.$id;g===t&&(d.resolve(null),c(e.currentScope))}});var t={$scope:u,parameters:r},n=s(a);l=i(a,t),n.isControllerAs&&(l.openModal=u.openModal,l.closeModal=u.closeModal),u.modal.show()},function(e){d.reject(e)}),d.promise}function c(e){e.$destroy(),e.modal&&e.modal.remove()}function s(e){var t={isControllerAs:!1,controllerName:"",propName:""},n=(e||"").trim().split(/\s+/);return t.isControllerAs=3===n.length&&"as"===(n[1]||"").toLowerCase(),t.isControllerAs?(t.controllerName=n[0],t.propName=n[2]):t.controllerName=e,t}return{show:a}}),angular.module("hariRtc.services").factory("signaling",function(e,t){t.signalingEndpoint||(t.signalingEndpoint="https://irest.pitt.edu:8080/");var n=io.connect(t.signalingEndpoint,{secure:!0}),e=e({ioSocket:n});return e});
!function(n){n.module("hariRtc.config",[]).value("hariRtc.config",{debug:!0}),n.module("hariRtc.directives",[]),n.module("hariRtc.services",[]),n.module("hariRtc",["btford.socket-io","ionic","app.config","hariRtc.config","hariRtc.directives","hariRtc.services"])}(angular),angular.module("hariRtc").run(function(n,e){e.on("messageReceived",function(n,e){switch(e.type){case"call":iRestModal.show("views/call.html","CallCtrl",{isCalling:!1,contactName:n})}})}),angular.module("hariRtc").run(["$templateCache",function(n){n.put("views/call.html",'<ion-content on-scroll="updateVideoPosition()" on-scroll-complete="updateVideoPosition()">\n    <div class="calling-container" ng-if="isCalling && !callInProgress">\n      <p>Calling to <span class="balanced">{{ contactName }}</span>...</p>\n\n      <button class="button button-assertive" ng-click="ignore()">\n        Nevermind\n      </button>\n    </div>\n\n    <div class="calling-container" ng-if="!isCalling && !callInProgress">\n      <p><span class="balanced">{{ contactName }}</span> is calling you</p>\n\n      <button class="button button-positive" ng-click="answer()">\n        Answer\n      </button>\n\n      <button class="button button-assertive" ng-click="ignore()">\n        Ignore\n      </button>\n    </div>\n\n    <div class="calling-container" ng-if="callInProgress">\n      <p>\n        Call in progress...\n      </p>\n\n      <button class="button button-assertive" ng-click="end()">\n        End\n      </button>\n    </div>\n\n    <video-view></video-view>\n\n  </ion-content>')}]),angular.module("hariRtc").controller("CallCtrl",function(n,e,t,o,i,a,c,s){function r(e,t){console.log((new Date).toString()+": calling to "+t+", isInitiator: "+e),clearInterval(window.ringingIntervalId);var o={isInitiator:e,turn:{host:"stun:stun.l.google.com:19302",username:"test",password:"test"},streams:{audio:!0,video:!0}},i=new cordova.plugins.phonertc.Session(o);i.on("sendMessage",function(n){a.emit("sendMessage",t,{type:"phonertc_handshake",data:JSON.stringify(n)})}),i.on("answer",function(){console.log("Answered!")}),i.on("disconnect",function(){n.contacts[t]&&delete n.contacts[t],0===Object.keys(n.contacts).length&&(a.emit("sendMessage",t,{type:"ignore"}),n.closeModal())}),i.call(),n.contacts[t]=i}function l(e,t){switch(t.type){case"answer":n.$apply(function(){n.callInProgress=!0,o(n.updateVideoPosition,1e3)});var i=Object.keys(n.contacts);0!==i.length&&a.emit("sendMessage",e,{type:"add_to_group",contacts:i,isInitiator:!1}),r(!0,e);break;case"ignore":var s=Object.keys(n.contacts).length;if(s>0){n.contacts[e]&&(n.contacts[e].close(),delete n.contacts[e]);var l=n.hideFromContactList.indexOf(e);l>-1&&n.hideFromContactList.splice(l,1),0===Object.keys(n.contacts).length&&n.closeModal()}else n.closeModal();break;case"phonertc_handshake":-1===d.indexOf(t.data)&&(n.contacts[e].receiveMessage(JSON.parse(t.data)),d.push(t.data));break;case"add_to_group":t.contacts.forEach(function(e){n.hideFromContactList.push(e),r(t.isInitiator,e),t.isInitiator||o(function(){a.emit("sendMessage",e,{type:"add_to_group",contacts:[c.currentName],isInitiator:!0})},1500)})}}console.log("parameter "+JSON.stringify(s));var d=[];n.callInProgress=!1,n.isCalling=s.isCalling,n.contactName=s.contactName,n.allContacts=c.onlineUsers,n.contacts={},n.hideFromContactList=[n.contactName],n.muted=!1,i.fromTemplateUrl("templates/select_contact.html",{scope:n,animation:"slide-in-up"}).then(function(e){n.selectContactModal=e}),navigator.notification.beep(1),window.ringingIntervalId=setInterval(navigator.notification.beep,2500,1),n.isCalling&&a.emit("sendMessage",s.contactName,{type:"call"}),n.ignore=function(){clearInterval(window.ringingIntervalId);var e=Object.keys(n.contacts);e.length>0?n.contacts[e[0]].disconnect():(a.emit("sendMessage",s.contactName,{type:"ignore"}),n.closeModal())},n.end=function(){clearInterval(window.ringingIntervalId),Object.keys(n.contacts).forEach(function(e){n.contacts[e].close(),delete n.contacts[e]}),n.closeModal()},n.answer=function(){n.callInProgress||(n.callInProgress=!0,o(n.updateVideoPosition,1e3),r(!1,s.contactName),setTimeout(function(){console.log("sending answer"),a.emit("sendMessage",s.contactName,{type:"answer"})},1500))},n.updateVideoPosition=function(){t.$broadcast("videoView.updatePosition")},n.openSelectContactModal=function(){cordova.plugins.phonertc.hideVideoView(),n.selectContactModal.show()},n.closeSelectContactModal=function(){cordova.plugins.phonertc.showVideoView(),n.selectContactModal.hide()},n.addContact=function(e){n.hideFromContactList.push(e),a.emit("sendMessage",e,{type:"call"}),cordova.plugins.phonertc.showVideoView(),n.selectContactModal.hide()},n.hideCurrentUsers=function(){return function(e){return-1===n.hideFromContactList.indexOf(e)}},n.toggleMute=function(){n.muted=!n.muted,Object.keys(n.contacts).forEach(function(e){var t=n.contacts[e];t.streams.audio=!n.muted,t.renegotiate()})},a.on("messageReceived",l),n.$on("$destroy",function(){clearInterval(window.ringingIntervalId),a.removeListener("messageReceived",l)})}),angular.module("hariRtc.directives").directive("videoView",function(n,e){return{restrict:"E",template:'<div class="video-container"></div>',replace:!0,link:function(t,o){function i(){cordova.plugins.phonertc.setVideoView({container:o[0],local:{position:[240,240],size:[50,50]}})}e(i,500),n.$on("videoView.updatePosition",i)}}}),angular.module("hariRtc.services").factory("ContactsService",function(n){var e=[];return n.on("online",function(n){-1===e.indexOf(n)&&e.push(n)}),n.on("offline",function(n){var t=e.indexOf(n);-1!==t&&e.splice(t,1)}),{onlineUsers:e,setOnlineUsers:function(n,t){this.currentName=t,e.length=0,n.forEach(function(n){n!==t&&e.push(n)})}}}),angular.module("hariRtc.services").factory("hariModal",function(n,e,t,o,i){function a(o,a,r){var l,d=t.defer(),u=e.$new(),g=u.$id;return n.fromTemplateUrl(o,{scope:u,animation:"slide-in-up"}).then(function(n){u.modal=n,u.openModal=function(){u.modal.show()},u.closeModal=function(n){d.resolve(n),u.modal.hide()},u.$on("modal.hidden",function(n){if(n.currentScope){var e=n.currentScope.$id;g===e&&(d.resolve(null),c(n.currentScope))}});var e={$scope:u,parameters:r},t=s(a);l=i(a,e),t.isControllerAs&&(l.openModal=u.openModal,l.closeModal=u.closeModal),u.modal.show()},function(n){d.reject(n)}),d.promise}function c(n){n.$destroy(),n.modal&&n.modal.remove()}function s(n){var e={isControllerAs:!1,controllerName:"",propName:""},t=(n||"").trim().split(/\s+/);return e.isControllerAs=3===t.length&&"as"===(t[1]||"").toLowerCase(),e.isControllerAs?(e.controllerName=t[0],e.propName=t[2]):e.controllerName=n,e}return{show:a}}),angular.module("hariRtc.services").factory("signaling",function(n,e){e.signalingEndpoint||(e.signalingEndpoint="https://irest.pitt.edu:8080/");var t=io.connect(ENV.signalingEndpoint,{secure:!0}),n=n({ioSocket:t});return n});
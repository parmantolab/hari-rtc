!function(n){n.module("hariRtc.config",[]).value("hariRtc.config",{debug:!0}),n.module("hariRtc.directives",[]),n.module("hariRtc.services",[]),n.module("hariRtc",["btford.socket-io","ionic","app.config","hariRtc.config","hariRtc.directives","hariRtc.services"])}(angular),angular.module("hariRtc").run(["$state","signaling","hariModal",function(n,t,e){t.on("messageReceived",function(n,t){switch(t.type){case"call":e.show("views/call.html","CallCtrl",{isCalling:!1,contactName:n})}})}]),angular.module("hariRtc").run(["$templateCache",function(n){n.put("views/call.html",'<ion-content on-scroll="updateVideoPosition()" on-scroll-complete="updateVideoPosition()">\n    <div class="calling-container" ng-if="isCalling && !callInProgress">\n      <p>Calling to <span class="balanced">{{ contactName }}</span>...</p>\n\n      <button class="button button-assertive" ng-click="ignore()">\n        Nevermind\n      </button>\n    </div>\n\n    <div class="calling-container" ng-if="!isCalling && !callInProgress">\n      <p><span class="balanced">{{ contactName }}</span> is calling you</p>\n\n      <button class="button button-positive" ng-click="answer()">\n        Answer\n      </button>\n\n      <button class="button button-assertive" ng-click="ignore()">\n        Ignore\n      </button>\n    </div>\n\n    <div class="calling-container" ng-if="callInProgress">\n      <p>\n        Call in progress...\n      </p>\n\n      <button class="button button-assertive" ng-click="end()">\n        End\n      </button>\n    </div>\n\n    <video-view></video-view>\n\n  </ion-content>'),n.put("views/select_contact.html",'<ion-modal-view>\n  <ion-header-bar class="bar-positive">\n    <h1 class="title">Add Contact to Call</h1>\n      <button class="button button-clear" ng-click="closeSelectContactModal()">\n        Close\n      </button>\n  </ion-header-bar>\n  <ion-content>\n    <ul class="list">\n      <li class="item item-button-right"\n          ng-repeat="contact in allContacts | filter:hideCurrentUsers()">\n        <i class="icon ion-record" style="color: green"></i>\n        {{ contact }}\n        <button class="button button-positive" \n                ng-click="addContact(contact)">\n          <i class="icon ion-ios7-telephone"></i>\n        </button>\n      </li>\n    </ul>\n  </ion-content>\n</ion-modal-view>')}]),angular.module("hariRtc").controller("CallCtrl",["$scope","$state","$rootScope","$timeout","$ionicModal","signaling","ContactsService","parameters",function(n,t,e,o,i,a,c,s){function l(t,e){console.log((new Date).toString()+": calling to "+e+", isInitiator: "+t),clearInterval(window.ringingIntervalId);var o={isInitiator:t,turn:{host:"stun:stun.l.google.com:19302",username:"test",password:"test"},streams:{audio:!0,video:!0}},i=new cordova.plugins.phonertc.Session(o);i.on("sendMessage",function(n){a.emit("sendMessage",e,{type:"phonertc_handshake",data:JSON.stringify(n)})}),i.on("answer",function(){console.log("Answered!")}),i.on("disconnect",function(){n.contacts[e]&&delete n.contacts[e],0===Object.keys(n.contacts).length&&(a.emit("sendMessage",e,{type:"ignore"}),n.closeModal())}),i.call(),n.contacts[e]=i}function r(t,e){switch(e.type){case"answer":n.$apply(function(){n.callInProgress=!0,o(n.updateVideoPosition,1e3)});var i=Object.keys(n.contacts);0!==i.length&&a.emit("sendMessage",t,{type:"add_to_group",contacts:i,isInitiator:!1}),l(!0,t);break;case"ignore":var s=Object.keys(n.contacts).length;if(s>0){n.contacts[t]&&(n.contacts[t].close(),delete n.contacts[t]);var r=n.hideFromContactList.indexOf(t);r>-1&&n.hideFromContactList.splice(r,1),0===Object.keys(n.contacts).length&&n.closeModal()}else n.closeModal();break;case"phonertc_handshake":-1===d.indexOf(e.data)&&(n.contacts[t].receiveMessage(JSON.parse(e.data)),d.push(e.data));break;case"add_to_group":e.contacts.forEach(function(t){n.hideFromContactList.push(t),l(e.isInitiator,t),e.isInitiator||o(function(){a.emit("sendMessage",t,{type:"add_to_group",contacts:[c.currentName],isInitiator:!0})},1500)})}}console.log("parameter "+JSON.stringify(s));var d=[];n.callInProgress=!1,n.isCalling=s.isCalling,n.contactName=s.contactName,n.allContacts=c.onlineUsers,n.contacts={},n.hideFromContactList=[n.contactName],n.muted=!1,i.fromTemplateUrl("views/select_contact.html",{scope:n,animation:"slide-in-up"}).then(function(t){n.selectContactModal=t}),navigator.notification.beep(1),window.ringingIntervalId=setInterval(navigator.notification.beep,2500,1),n.isCalling&&a.emit("sendMessage",s.contactName,{type:"call"}),n.ignore=function(){clearInterval(window.ringingIntervalId);var t=Object.keys(n.contacts);t.length>0?n.contacts[t[0]].disconnect():(a.emit("sendMessage",s.contactName,{type:"ignore"}),n.closeModal())},n.end=function(){clearInterval(window.ringingIntervalId),Object.keys(n.contacts).forEach(function(t){n.contacts[t].close(),delete n.contacts[t]}),n.closeModal()},n.answer=function(){n.callInProgress||(n.callInProgress=!0,o(n.updateVideoPosition,1e3),l(!1,s.contactName),setTimeout(function(){console.log("sending answer"),a.emit("sendMessage",s.contactName,{type:"answer"})},1500))},n.updateVideoPosition=function(){e.$broadcast("videoView.updatePosition")},n.openSelectContactModal=function(){cordova.plugins.phonertc.hideVideoView(),n.selectContactModal.show()},n.closeSelectContactModal=function(){cordova.plugins.phonertc.showVideoView(),n.selectContactModal.hide()},n.addContact=function(t){n.hideFromContactList.push(t),a.emit("sendMessage",t,{type:"call"}),cordova.plugins.phonertc.showVideoView(),n.selectContactModal.hide()},n.hideCurrentUsers=function(){return function(t){return-1===n.hideFromContactList.indexOf(t)}},n.toggleMute=function(){n.muted=!n.muted,Object.keys(n.contacts).forEach(function(t){var e=n.contacts[t];e.streams.audio=!n.muted,e.renegotiate()})},a.on("messageReceived",r),n.$on("$destroy",function(){clearInterval(window.ringingIntervalId),a.removeListener("messageReceived",r)})}]),angular.module("hariRtc.directives").directive("videoView",["$rootScope","$timeout",function(n,t){return{restrict:"E",template:'<div class="video-container"></div>',replace:!0,link:function(e,o){function i(){cordova.plugins.phonertc.setVideoView({container:o[0],local:{position:[240,240],size:[50,50]}})}t(i,500),n.$on("videoView.updatePosition",i)}}}]),angular.module("hariRtc.services").factory("ContactsService",["signaling",function(n){var t=[];return n.on("online",function(n){-1===t.indexOf(n)&&t.push(n)}),n.on("offline",function(n){var e=t.indexOf(n);-1!==e&&t.splice(e,1)}),{onlineUsers:t,setOnlineUsers:function(n,e){this.currentName=e,t.length=0,n.forEach(function(n){n!==e&&t.push(n)})}}}]),angular.module("hariRtc.services").factory("hariModal",["$ionicModal","$rootScope","$q","$injector","$controller",function(n,t,e,o,i){function a(o,a,l){var r,d=e.defer(),u=t.$new(),g=u.$id;return n.fromTemplateUrl(o,{scope:u,animation:"slide-in-up"}).then(function(n){u.modal=n,u.openModal=function(){u.modal.show()},u.closeModal=function(n){d.resolve(n),u.modal.hide()},u.$on("modal.hidden",function(n){if(n.currentScope){var t=n.currentScope.$id;g===t&&(d.resolve(null),c(n.currentScope))}});var t={$scope:u,parameters:l},e=s(a);r=i(a,t),e.isControllerAs&&(r.openModal=u.openModal,r.closeModal=u.closeModal),u.modal.show()},function(n){d.reject(n)}),d.promise}function c(n){n.$destroy(),n.modal&&n.modal.remove()}function s(n){var t={isControllerAs:!1,controllerName:"",propName:""},e=(n||"").trim().split(/\s+/);return t.isControllerAs=3===e.length&&"as"===(e[1]||"").toLowerCase(),t.isControllerAs?(t.controllerName=e[0],t.propName=e[2]):t.controllerName=n,t}return{show:a}}]),angular.module("hariRtc.services").factory("signaling",["socketFactory","env",function(n,t){t.signalingEndpoint||(t.signalingEndpoint="https://irest.pitt.edu:8080/");var e=io.connect(t.signalingEndpoint,{secure:!0}),n=n({ioSocket:e});return n}]);